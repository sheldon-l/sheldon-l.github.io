---
layout: default
title: Node.js With Passport Authentication with Mongo
published_at: "2019-03-02"
updated_at: "2020-03-02"
author: Taners
---

[BACK TO HOME](https://tane-rs.github.io)

# {{page.title}}

by {{page.author}} |
published at {{page.published_at | date: "%Y-%m-%d"}} |
updated at {{ page.updated_at | date: "%Y-%m-%d" }}

---

## MogoDB

- Login MongoDB, create a cluster, choose a provider (AWS here);
- set `Security`: add a user to the cluster, give full previlage, then add IP address  (0.0.0.0 (anyone can access)) here;
- click `connect`, choose `to Application`, copy link like this: `mongodb+srv://sheldon:<password>@nodejscourse-wtt3y.mongodb.net/test?retryWrites=true&w=majority`

## Start Project

- Init node.js project and install packages

```bash
npm init -y
npm i bcryptjs connect-flash ejs express express-ejs-layouts express-session passport passport-local mongoose
npm i -D nodemon  # dev
```

- `package.js` scripts

```json
"main": "app.js"
"scripts": {
	"start": "node app.js",
	"dev": "nodemon app.js"
}
```

- New `app.js`

```js
const express = require('express')

const app = express();


// DB config here

// Add middle ware here

// Add routs here


const PORT = process.env.PORT || 5000;

app.listen(PORT, console.log(`Server started on ${PORT}`));
```

- Run and check

```bash
npm run dev
```

## Routes

- `mkdir routes`

```bash
touch routes/index.js
touch routes/users.js
```

- `vim routes/index.js`

```js
const express = require('express');
const router = express.Router();

router.get('/', (req, res) => res.send('Welcome'))

module.exports = router
```

- `vim app.js`

```js
// Routes
app.use('/', require('./routes/index'));
app.use('/users', require('./routes/users'));
```

- `vim routes/users.js`

```js
const express = require('express');
const router = express.Router();

// Login page
router.get('/login', (req, res) => res.send('Login')) // not rendered yet

// Register page
router.get('/register', (req, res) => res.send('Register'))

// Register handle...

module.exports = router
```

## EJS and render

### Render the welcome

- `vim app.js`

```js
const expressLayouts = require('express-ejs-layouts')

// Middle ware
// EJS
app.use(expressLayouts);
app.set('view engine', 'ejs')  // see below
```

- `mkdir views`

```bash
touch views/layout.ejs
touch views/welcome.ejs
touch views/login.ejs
touch views/register.ejs
touch views/dashboard.ejs
```

- `vim views/layout.ejs`

```html
<head>
    <!-- meta -->

    <title>Node Passport</title>

    <!-- bootswatch CSS link here. -->
    <!-- fontawesome link here -->

    <!-- some other styles -->
</head>

<body>
    <div class="container">
        <%- body %>
    </div>

    <!-- bootstrap JS scripts here. -->
</body>
```

- `vim views/welcome.ejs`

```html
<div class="somecontainer">
	<p>Create an account or login</p>
	<!-- register button -->
	<!-- login button -->
</div>
``` 

- `vim routes/index.js`

```js
const express = require('express');
const router = express.Router();

router.get('/', (req, res) => res.render('welcome'))  // modify here

module.exports = router
```

### Render the login and register (similar as `index.js` above)

- `vim views/register.ejs`

- `vim routes/users.js`

## Mongoose

- `mkdir config & vim config/keys.js`

```js
module.exports = {
    mongoURI: "mongodb+srv://<user>:<password>@nodejscourse-wtt3y.mongodb.net/test?retryWrites=true&w=majority" // connection application code of mangodb
}
```

- `vim app.js`

```js
const mongoose = require('mongoose')

// DB config
const db = require('./config/keys').mongoURI;
mongoose.connect(db, { useNewUrlParser: true })
    .then(console.log('MongoDB connected'))
    .catch(err => console.log(err));
```

## Models

- `mkdir models & vim models/User.js`

```js
const mongoose = require('mongoose')

const UserSchema = new mongoose.Schema({
    name: {
        type: String,
        required: true,

    },
    email: {
        type: String,
        required: true,

    },
    password: {
        type: String,
        required: true,

    },
    date: {
        type: Date,
        default: Date.now
    }
});

const User = mongoose.model('User', UserSchema);

module.exports = User;
```

- `vim app.js`

```js
// Middleware
// Bodyparser
app.use(express.urlencoded({ extended:true }));
```

- `vim routes/users.js`

```js
// Register handle
router.post('/register', (req, res) => {
    console.log(req.body)
    res.send('Success')
})

	const { name, email, password1, pasword2 } = req.body;
    let errs = [];
    if ( !name || !email || !password1 || !pasword2 ) {
        errs.push({ msg: 'All these fields are required!' })
    };
    if ( password1.length < 8 ) {
        errs.push({ msg: 'Password should greater than 8 characters!' })
    };
    if ( password1 !== pasword2 ) {
        errs.push({ msg: 'Passwords not match!' })
    };

```
