---
layout: post
title: PHP 10 - Biuld Laraval Blog CMS
published_at: "2020-08-11"
updated_at: "2020-08-11"
author: Sheldon L
tags: [PHP, Laravel, Blog, CMS]
---

## Featurs

- CMS for admin:
    - Gallery
    - Category
    - Post
    - Page
- Contact

## Start

### Create Project

```bash
laravel new blog
cd blog

# set database in .env

composer require laravel/ui --dev
php artisan ui bootstrap --auth
npm install && npm run dev
```

### Create Tables

```bash
php artisan make:model Category -mcr
php artisan make:model Post -mcr
php artisan make:model Gallery -mcr

php artisan make:model CategoryPost -m

php artisan make:controller WebsiteController
php artisan make:controller PageController
```

### Table Schema

- Schema
- Deploy the schema to the migrations and models, and build relationships.
- AppServiceProvider.php

```php
# AppServiceProvider.php

public function boot()
{
    Schema::defaultStringLength(191);
}
```

### Factory and Seeder

```bash
composer require laravel/helpers
php artisan make:seeder CategoriesTableSeeder
```

```php
# UserFactory.php
$factory->define(Admin::class, function (Faker $faker) {
    return [
        'name' => $faker->name,
        'email' => $faker->unique()->safeEmail,
        'email_verified_at' => now(),
        'password' => bcrypt('12345678'),
        'remember_token' => Str::random(10),
    ];
});

$factory->define(Post::class, function (Faker $faker) {
    $title = $faker->unique()->sentence;
    $isPublished = ['1', '0'];

    return [
        'admin_id' => rand(1, 5),
        'title' => ['cn' => rand(1, 10000).'中文标题'.rand(1, 10000), 'en' => $title],
        'slug' => str_slug($title),
        'sub_title' => ['cn' => rand(1, 10000).'中文副标题'.rand(1, 10000), 'en' => $faker->sentence],
        'details' => ['cn' => rand(1, 10000).'中文内容'.rand(1, 10000), 'en' => $faker->paragraph],
        'post_type' => 'post',
        'is_published' => $isPublished[rand(0, 1)],
        'created_at' => now(),
        'updated_at' => now(),
    ];
});

$factory->define(CategoryPost::class, function (Faker $faker) {
    return [
        'category_id' => rand(1, 5),
        'post_id' => rand(1, 100),
    ];
});
```

```php
# CategoriesTableSeeder
public function run()
{
    Category::create([
        'admin_id' => '1',
        'name' => ['cn'=>'长江计划', 'en'=>'Rever Development'],
        'slug' => 'rever_development',
        'is_published' => '1',
        'created_at' => Carbon::now(),
        'updated_at' => Carbon::now(),
    ]);
    Category::create([
        'admin_id' => '2',
        'name' => ['cn'=>'历史档案', 'en'=>'History'],
        'slug' => 'history',
        'is_published' => '1',
        'created_at' => Carbon::now(),
        'updated_at' => Carbon::now(),
    ]);
    Category::create([
        'admin_id' => '3',
        'name' => ['cn'=>'发射卫星', 'en'=>'Satellite'],
        'slug' => 'satellite',
        'is_published' => '1',
        'created_at' => Carbon::now(),
        'updated_at' => Carbon::now(),
    ]);
    Category::create([
        'admin_id' => '4',
        'name' => ['cn'=>'换飞机', 'en'=>'Airplane'],
        'slug' => 'airplane',
        'is_published' => '1',
        'created_at' => Carbon::now(),
        'updated_at' => Carbon::now(),
    ]);
    Category::create([
        'admin_id' => '5',
        'name' => ['cn'=>'鲨鱼苗', 'en'=>'Babyshark'],
        'slug' => 'babyshark',
        'is_published' => '1',
        'created_at' => Carbon::now(),
        'updated_at' => Carbon::now(),
    ]);
}
```

### Insert Dummy data

```bash
php artisan migrate

php artisan tinker
```

```php
factory(App\Admin::class, 5)->create()
factory(App\Post::class, 100)->create()
```

```bash
php artisan db:seed --class=CategoriesTableSeeder

php artisan tinker
```

```php
factory(App\CategoryPost::class, 100)->create()
```

## Routes

```php
// # User
    // Auth::routes();
    // Route::get('/home', 'HomeController@index')->name('home');
    // Route::post('/user/logout', 'Auth\LoginController@userLogout')->name('user.logout');

# Admin
Route::prefix('admin')->group(function () {
    # Dashboard
    Route::get('/', 'AdminController@index')->name('admin.dashboard');

    # Login and Logout
    Route::get('/login', 'Auth\AdminLoginController@showLoginForm')->name('admin.login');
    Route::post('/login', 'Auth\AdminLoginController@login')->name('admin.login.submit');
    Route::post('/logout', 'Auth\AdminLoginController@logout')->name('admin.logout');

    # No register, only can add admin in tinker for safe consideration

    # Reset password
    // Route::get('/password/reset', 'Auth\AdminForgotPasswordController@showLinkRequestForm')->name('admin.password.request');
    // Route::post('/password/email', 'Auth\AdminForgotPasswordController@sendResetLinkEmail')->name('admin.password.email');
    // Route::get('/password/reset/{token}', 'Auth\AdminResetPasswordController@showResetForm')->name('admin.password.reset');
    // Route::post('/password/reset', 'Auth\AdminResetPasswordController@reset')->name('admin.password.update');

    # CMS
    Route::resource('categories', 'CategoryController');
    Route::resource('posts', 'PostController');
    Route::resource('pages', 'PageController');
    Route::resource('galleries', 'GalleryController');

});

Route::group(['prefix' => '{locale?}'], function() {

    # Web
    Route::get('/', 'WebsiteController@index')->name('index');
    Route::get('categories', 'WebsiteController@categories')->name('categories');
    Route::get('category/{slug}', 'WebsiteController@category')->name('category');
    Route::get('post/{slug}', 'WebsiteController@post')->name('post');
    Route::get('page/{slug}', 'WebsiteController@page')->name('page');
    Route::get('contact', 'WebsiteController@showMessageForm')->name('messages.show');
    Route::post('contact', 'WebsiteController@submitMessageForm')->name('messages.submit');
});
```

## Website (Guest Route)
### Templates

- Download template from <https://startbootstrap.com/themes/clean-blog/>
- Copy `css`, `img`, `js` and `vender` to `public/website`
- Copy `index.html` to `resources/views/website/template/master.blade.php`, change the links as `{{ asset('website/...') }}`, modify content to the format `{{__('')}}`
- Cut 'Header' and 'Main Conent' to `resources/views/website/index.blade.php` as 'content' `section`, change background image url.
- Add index method in `WebsiteController`.

```php
return view('website.index');
```

- Visit website.

- Add Category Features in Blog

### Post List on Website Home

```php
# WebsiteController
public function index() {
    $posts = Post::orderBy('updated_at', 'DESC')->where('post_type', 'post')->where('is_published', '1')->paginate();
    $categories = Category::orderBy('category_name', 'ASC')->where('is_published', '1')->get();
    return view('website.index', compact('posts', 'categories'));
}
```

- Add `@foreache` $posts and $categories in 'index'
- Add paginate of posts: `{{ $posts->links() }}`

### Post Details Page

- Create `resource/views/website/post.blade.php` with `@extends()`, copy post template of bootstrap to it.

```php
# WebsiteController
public function post($slug) {
    $post = Post::where('slug', $slug)->where('post_type', 'post')->where('is_published', '1')->first();
    if ($post) {
        return view('website.post', compact('post'));
    }
}
```
- Add $post in 'post'

### Post List in Categories

- Create `resource/views/website/category.blade.php` with `@extends()`, copy index to it and modify.

```php
# WebsiteControll

public function category($slug) {
    $category = Category::where('slug', $slug)->where('is_published', '1')->first();
    $categories = Category::orderBy('category_name', 'ASC')->where('is_published', '1')->get();
    if ($category) {
        $posts = $category->posts()->orderBy('post_id', 'DESC')->where('is_published', '1')->paginate(5);
        return view('website.category', compact('category', 'posts', 'categories'));
    }
}
```

## Admin Panel

### Dashboard

- Add categories, posts, pages, galleries and @yield('stylesheet'), @yield('javascript') to `app.blade.php`
- Create `resource/views/admin/index.blade.php`, copy home.blade.php to
- Open `AdminController.php` and edit index method and add @foreach for latest categoryies and posts.

### Category CRUD

- Create `index`, `create`, `edit` blade in `admin/category/`.
- `CategoryController.php`

```php
# add middleware, same as post, page, gallery 

/**
    * Create a new controller instance.
    *
    * @return void
    */
public function __construct()
{
    $this->middleware('auth:admin');
}
```

- Install laravel collective:

```bash
# https://laravelcollective.com/docs/6.0/html
composer require laravelcollective/html
```

- Flash Sessions

```php
@if(Session::has('message'))
    <div class="alert alert-success alert-dismissible">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">x</button>
        {{ session('message') }}
    </div>
@endif
@if(Session::has('danger-message'))
    <div class="alert alert-danger alert-dismissible">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">x</button>
        {{ session('danger-message') }}
    </div>
@endif
@if(Session::has('warning-message'))
    <div class="alert alert-warning alert-dismissible">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">x</button>
        {{ session('warning-message') }}
    </div>
@endif
```

```php
# category/index.blade (similar as post, gallery, page)
<div class="card-header">
    <h2>{{ __('Gallery - List') }}</h2>
    <a href="{{ route('galleries.create') }}" class="btn btn-md btn-primary float-right">Add +</a>
</div>
<div class="card-body">
    <table class="table table-bordered mb-0">
        <thead>
            <tr>
                <th scope="col" width="20">{{ __('#') }}</th>
                <th scope="col" width="60">{{ __('Image Url') }}</th>
                <th scope="col" width="60">{{ __('Uploaded By') }}</th>
                <th scope="col" width="60">{{ __('Uploaded At') }}</th>
                <th scope="col" width="60">{{ __('Action') }}</th>
            </tr>
        </thead>
        <tbody>
            @foreach ($galleries as $gallery)
                <tr>
                    <td>{{ $gallery->id }}</td>
                    <td>{{ asset('storage/galleries/' . $gallery->image_url) }}</td>
                    <td>{{ $gallery->user->name }}</td>
                    <td>{{ $gallery->updated_at }}</td>
                    <td>
                        <a href="{{ route('galleries.edit', $gallery->id) }}" class="btn btn-sm btn-warning mr-2 px-2">Edit</a>
                        {!! Form::open(['route' => ['galleries.destroy', $gallery->id], 'method' => 'delete', 'style' => 'display:inline']) !!}
                        {!! Form::submit('Delete', ['class' => 'btn btn-sm btn-danger']) !!}
                        {!! Form::close() !!}
                    </td>
                </tr>
            @endforeach
        </tbody>
    </table>
</div>
```

#### Create

```php
# CategoryController.php
public function create()
{
    return view('admin.category.create');
}
```

```php
# category/create.blade.php
{!! Form::open(['route' => ['categories.store', app()->getLocale()]]) !!}
<div class="form-group @if($errors->has('thumbnail')) has-error @endif">
    {!! Form::label('thumbnail', trans('admin_category_create.thumbnail')) !!}
    <span class="text-red-500">&nbsp;</span>
    <a href="#" target="_blank" class="text-primary">
        {{ __('admin_category_create.gallery') }}
        <i class="fas fa-external-link-alt fa-sm"></i>
    </a>
    {!! Form::text('thumbnail', null, ['class' => 'form-control', 'placeholder' => trans('admin_category_create.paste_thumbnail_address_here')]) !!}
    @if ($errors->has('thumbnail'))
        <span class="help-block text-red-500">{!! $errors->first('thumbnail') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('name_cn')) has-error @endif">
    {!! Form::label('name_cn', trans('admin_category_create.category_name_cn')) !!}
    <span class="text-red-500">*&nbsp;</span>
    {!! Form::text('name_cn', null, ['class' => 'form-control', 'placeholder' => trans('admin_category_create.input_category_name_in_cn')]) !!}
    @if ($errors->has('name_cn'))
        <span class="help-block text-red-500">{!! $errors->first('name_cn') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('name_en')) has-error @endif">
    {!! Form::label('name_en', trans('admin_category_create.category_name_en')) !!}
    <span class="text-red-500">*&nbsp;</span>
    {!! Form::text('name_en', null, ['class' => 'form-control', 'placeholder' => trans('admin_category_create.input_category_name_in_en')]) !!}
    @if ($errors->has('name_en'))
        <span class="help-block text-red-500">{!! $errors->first('name_en') !!}</span>
    @endif
</div>
<div class="form-group">
    {!! Form::label('is_published', trans('admin_category_create.is_published')) !!}
    <span class="text-red-500">*&nbsp;</span>
    {!! Form::select('is_published', [0 => trans('admin_category_create.draft'), 1 => trans('admin_category_create.publish')], null, ['class' => 'form-control']) !!}
</div>
{!! Form::submit(trans('admin_category_create.create'), ['class' => 'btn btn-primary']) !!}
{!! Form::close() !!}
```

```php
# CategoryController.php
public function store(Request $request)
{
$this->validate($request,
        [
            'name_cn' => 'required|max:191|unique:categories,name->cn',
            'name_en' => 'required|max:191|unique:categories,name->en',
        ],
        [
            'name_cn.required' => trans('admin_category_create.enter_category_name_cn'),
            'name_en.required' => trans('admin_category_create.enter_category_name_en'),
            'name_cn.max' => trans('admin_category_create.category_name_max_cn'),
            'name_en.max' => trans('admin_category_create.category_name_max_en'),
            'name_cn.unique' => trans('admin_category_create.category_already_exist'),
            'name_en.unique' => trans('admin_category_create.category_already_exist'),
        ]
    );

    Category::create([
        'admin_id' => Auth::id(),
        'thumbnail' => $request->thumbnail,
        'name' => ['cn'=>$request->name_cn, 'en'=>$request->name_en],
        'slug' => str_slug($request->name_en),
        'is_published' => $request->is_published,
        'created_at' => Carbon::now(),
        'updated_at' => Carbon::now(),
    ]);

    Session::flash('message', trans('admin_category_create.category_created_successfully'));
    return redirect()->route('categories.index');
}
```

#### Delete

```php
# Controller
public function destroy(Category $category)
{
    $category->delete();

    Session::flash('danger-message', trans('admin_category_create.category_deleted_successfully'));
    return redirect()->route('categories.index');
}
```

#### Edit

```php
# Controller
public function edit(Category $category)
{
    return view('admin.category.edit', compact('category'));
}
```

```php
# form
public function update(Request $request, Category $category)
{
    $this->validate($request,
        [
            'name_cn' => 'required|max:191|unique:categories,name->cn,' . $category->id,
            'name_en' => 'required|max:191|unique:categories,name->en,' . $category->id,
        ],
        [
            'name_cn.required' => trans('admin_category_CRUD.enter_category_name_cn'),
            'name_en.required' => trans('admin_category_CRUD.enter_category_name_en'),
            'name_cn.max' => trans('admin_category_CRUD.category_name_max_cn'),
            'name_en.max' => trans('admin_category_CRUD.category_name_max_en'),
            'name_cn.unique' => trans('admin_category_CRUD.category_already_exist'),
            'name_en.unique' => trans('admin_category_CRUD.category_already_exist'),
        ]
    );

    $category->thumbnail = $request->thumbnail;
    $category->admin_id = Auth::id();
    $category->name = ['cn' => $request->name_cn, 'en' => $request->name_en];
    $category->slug = str_slug($request->name_en);
    $category->is_published = $request->is_published;
    $category->save();

    Session::flash('warning-message', trans('admin_category_CRUD.category_updated_successfully'));
    return redirect()->route('categories.index');
}
```

```php
# controller
{!! Form::open(['route' => ['categories.update', [$category->id, app()->getLocale()]], 'method'=>'put']) !!}
<div class="form-group @if($errors->has('thumbnail')) has-error @endif">
    {!! Form::label('thumbnail', trans('admin_category_CRUD.thumbnail')) !!}
    <span class="text-red-500">&nbsp;</span>
    <a href="#" target="_blank" class="text-primary">
        {{ __('admin_category_CRUD.gallery') }}
        <i class="fas fa-external-link-alt fa-sm"></i>
    </a>
    {!! Form::text('thumbnail', $category->thumbnail, ['class' => 'form-control', 'placeholder' => trans('admin_category_CRUD.paste_thumbnail_address_here')]) !!}
    @if ($errors->has('thumbnail'))
        <span class="help-block text-red-500">{!! $errors->first('thumbnail') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('name_cn')) has-error @endif">
    {!! Form::label('name_cn', trans('admin_category_CRUD.category_name_cn')) !!}
    <span class="text-red-500">*&nbsp;</span>
    {{ App::setLocale('cn') }}
    {!! Form::text('name_cn', $category->name, ['class' => 'form-control', 'placeholder' => trans('admin_category_CRUD.input_category_name_in_cn')]) !!}
    @if ($errors->has('name_cn'))
        <span class="help-block text-red-500">{!! $errors->first('name_cn') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('name_en')) has-error @endif">
    {!! Form::label('name_en', trans('admin_category_CRUD.category_name_en')) !!}
    <span class="text-red-500">*&nbsp;</span>
    {{ App::setLocale('en') }}
    {!! Form::text('name_en', $category->name, ['class' => 'form-control', 'placeholder' => trans('admin_category_CRUD.input_category_name_in_en')]) !!}
    @if ($errors->has('name_en'))
        <span class="help-block text-red-500">{!! $errors->first('name_en') !!}</span>
    @endif
</div>
<div class="form-group">
    {!! Form::label('is_published', trans('admin_category_CRUD.is_published')) !!}
    <span class="text-red-500">*&nbsp;</span>
    {!! Form::select('is_published', [0 => trans('admin_category_CRUD.draft'), 1 => trans('admin_category_CRUD.publish')], isset($category->is_published) ? $category->is_published : null, ['class' => 'form-control']) !!}
</div>
{!! Form::submit(trans('admin_category_CRUD.update'), ['class' => 'btn btn-warning']) !!}
{!! Form::close() !!}
```

### Post CRUD

### Create

```php
# Controller
public function create()
{
    $categories = Category::orderBy('id', 'DESC')->pluck('category_name', 'id');
    return view('admin.post.create', compact('categories'));
}
```

```php
# form
{!! Form::open(['route' => 'posts.store']) !!}
<div class="form-group @if($errors->has('thumbnail')) has-error @endif">
    {!! Form::label('Thumbnail') !!}
    {!! Form::text('thumbnail', null, ['class' => 'form-control', 'placeholder' => 'Thumbnail url']) !!}
    @if ($errors->has('thumbnail'))
        <span class="help-block">{!! $errors->first('thumbnail') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('title')) has-error @endif">
    {!! Form::label('Title') !!}
    {!! Form::text('title', null, ['class' => 'form-control', 'placeholder' => 'Title']) !!}
    @if ($errors->has('title'))
        <span class="help-block">{!! $errors->first('category_name') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('sub_title')) has-error @endif">
    {!! Form::label('Sub Title') !!}
    {!! Form::text('sub_title', null, ['class' => 'form-control', 'placeholder' => 'Sub Title']) !!}
    @if ($errors->has('sub_title'))
        <span class="help-block">{!! $errors->first('category_name') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('details')) has-error @endif">
    {!! Form::label('Details') !!}
    {!! Form::textarea('details', null, ['class' => 'form-control', 'placeholder' => 'Details']) !!}
    @if ($errors->has('details'))
        <span class="help-block">{!! $errors->first('details') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('category_id')) has-error @endif">
    {!! Form::label('Category') !!}
    {!! Form::select('category_id', $categories, null, ['class' => 'form-control', 'id'=>'category_id', 'multiple'=>'multiple']) !!}
    @if ($errors->has('category_id'))
        <span class="help-block">{!! $errors->first('category_id') !!}</span>
    @endif
</div>
<div class="form-group">
    {!! Form::label('Publish or Draft') !!}
    {!! Form::select('is_published', [1 => 'Publish', 0 => 'Draft'], null, ['class' => 'form-control']) !!}
</div>
{!! Form::submit('Create', ['class' => 'btn btn-sm btn-primary']) !!}
{!! Form::close() !!}
```

```php
# css for select2
@section('stylesheet')
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
@endsection

# js for jquery, ckeditor, select2 (you can run `npm install select2`)
@section('javascript')
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.ckeditor.com/4.14.1/standard/ckeditor.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

<script type="text/javascript">
    $(document).ready(function () {

        CKEDITOR.replace('details');

        $('#category_id').select2({
            placeholder: "Select categories"
        });

    });
</script>
@endsection
```

```php
# Controller
public function store(Request $request)
{
    $this->validate($request,
        [
            'title' => 'required|unique:posts',
            'details' => 'required',
        ],
        [
            'title.required' => 'Enter title',
            'title.unique' => 'Post already exist',
            'details.required' => 'Enter details',
        ],
    );

    $post = new Post();
    $post->user_id = Auth::id();
    $post->thumbnail = $request->thumbnail;
    $post->title = $request->title;
    $post->slug = str_slug($request->title);
    $post->sub_title = $request->sub_title;
    $post->details = $request->details;
    $post->is_published = $request->is_published;
    $post->post_type = 'post';
    $post->save();

    $post->categories()->sync($request->category_id, false);

    Session::flash('message', 'Post created successfully');
    return redirect()->route('posts.index');
}
```

#### Delete

```php
public function destroy(Post $post)
{
    $post->delete();

    Session::flash('danger-message', 'Category deleted successfully');
    return redirect()->route('categories.index');
}
```

#### Edit

```php
public function edit(Post $post)
{
    $categories = Category::orderBy('id', 'DESC')->pluck('category_name', 'id');
    return view('admin.post.edit', compact('post', 'categories'));
}
```

```php
{!! Form::open(['route' => ['posts.update', $post->id], 'method'=>'put']) !!}
<div class="form-group @if($errors->has('thumbnail')) has-error @endif">
    {!! Form::label('Thumbnail') !!}
    {!! Form::text('thumbnail', $post->thumbnail, ['class' => 'form-control', 'placeholder' => 'Thumbnail url']) !!}
    @if ($errors->has('thumbnail'))
        <span class="help-block">{!! $errors->first('thumbnail') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('title')) has-error @endif">
    {!! Form::label('Title') !!}
    {!! Form::text('title', $post->title, ['class' => 'form-control', 'placeholder' => 'Title']) !!}
    @if ($errors->has('title'))
        <span class="help-block">{!! $errors->first('title') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('sub_title')) has-error @endif">
    {!! Form::label('Sub Title') !!}
    {!! Form::text('sub_title', $post->sub_title, ['class' => 'form-control', 'placeholder' => 'Sub Title']) !!}
    @if ($errors->has('sub_title'))
        <span class="help-block">{!! $errors->first('sub_title') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('details')) has-error @endif">
    {!! Form::label('Details') !!}
    {!! Form::textarea('details', $post->details, ['class' => 'form-control', 'placeholder' => 'Details']) !!}
    @if ($errors->has('details'))
        <span class="help-block">{!! $errors->first('details') !!}</span>
    @endif
</div>
<div class="form-group @if($errors->has('category_id')) has-error @endif">
    {!! Form::label('Category') !!}
    {!! Form::select('category_id', $categories, null, ['class' => 'form-control', 'id'=>'category_id', 'multiple'=>'multiple']) !!}
    @if ($errors->has('category_id'))
        <span class="help-block">{!! $errors->first('category_id') !!}</span>
    @endif
</div>
<div class="form-group">
    {!! Form::label('Publish or Draft') !!}
    {!! Form::select('is_published', [1 => 'Publish', 0 => 'Draft'], isset($post->is_published) ? $post->is_published : null, ['class' => 'form-control']) !!}
</div>
{!! Form::submit('Update', ['class' => 'btn btn-sm btn-warning']) !!}
{!! Form::close() !!}
```

```php
<script type="text/javascript">
    $(document).ready(function () {

        CKEDITOR.replace('details');

        $('#category_id').select2({
            placeholder: "Select categories"
        }).val({!! json_encode($post->categories()->allRelatedIds()) !!}).trigger('change');

    });
</script>
```

```php
# Controller
public function update(Request $request, Post $post)
{
    $this->validate($request,
        [
            'title' => 'required|unique:posts,title,' . $post->id . ',id',
            'details' => 'required',
        ],
        [
            'title.required' => 'Enter title',
            'title.unique' => 'Post already exist',
            'details.required' => 'Enter details',
        ],
    );

    $post->user_id = Auth::id();
    $post->thumbnail = $request->thumbnail;
    $post->title = $request->title;
    $post->slug = str_slug($request->title);
    $post->sub_title = $request->sub_title;
    $post->details = $request->details;
    $post->is_published = $request->is_published;
    $post->post_type = 'post';
    $post->save();

    $post->categories()->sync($request->category_id, false);

    Session::flash('warning-message', 'Post updated successfully');
    return redirect()->route('posts.index');
}
```

### Pages CRUD

- Similar to Post CRUD

- Create `app/Http/Helpers/helpers.php`

```php
function getPages()
{
    $pages = Post::where('post_type', 'page')->where('is_published', '1');
    return $pages;
}
```

- Open `composer.json`, add `helpers.php` path in `"autoload": {}`:

```php
"files": [
    "app/Http/Helpers/helpers.php"
]
```

- Rerun composer autoload

```bash
composer dump-autoload
```

- Open `views/website/template/master.blade.php`, add getPages() method, add `@foreach` to get all pages with links

```php
@php ($pages = getPages())
@foreach ($pages as $page)
<li class="nav-item">
    <a class="nav-link" href="{{ route('page', $page->slug) }}">{{ $page->title }}</a>
</li>
@endforeach
```

- Create `views/website/page.blade.php`, copy and paste `post.blade.php` and modify

- Open `WebsiteController.php` and page() method

```php
public function page($slug) {
    $page = Post::where('slug', $slug)->where('post_type', 'page')->where('is_published', '1')->first();
    if ($page) {
        return view('website.page', compact('page'));
    }
}
```

### Galleries CRUD

- create `index`, `create`, `edit` in `view/admin/gallery`

```php
# Conroller

public function index()
{
    $galleries = Gallery::orderBy('id', 'DESC')->get();
    return view('admin.gallery.index', compact('galleries'));
}

public function create()
{
    return view('admin.gallery.create');
}

public function store(Request $request)
{
    $this->validate($request,
        [
            "image_url" => "required",
        ],
        [
            "image_url.required" => 'Select image',
        ]
    );

    foreach ($request->image_url as $image_url) {

        $fileNameWithExt = $image_url->getClientOriginalName();
        $fileName = pathinfo($fileNameWithExt, PATHINFO_FILENAME);
        $fileExt = $image_url->getClientOriginalExtension();
        $fileNameToStore = $fileName . '_' . $fileExt;

        $gallery = new Gallery();
        $gallery->user_id = Auth::id();
        $gallery->image_url = $fileNameToStore;
        $save = $gallery->save();

        if ($save) {
            $image_url->storeAs('public/galleries', $fileNameToStore);
        }
    }
    Session::flash('message', 'Images uploaded successfully');
    return redirect()->route('galleries.index');
}

public function destroy(Gallery $gallery)
{
    Storage::delete('public/galleries' . $gallery->image_url);
    $gallery->delete();

    Session::flash('danger-message', 'Images deleted successfully');
    return redirect()->route('galleries.index');
}
```

```php
# create.blade
{!! Form::open(['route' => 'galleries.store', 'enctype' => 'multipart/form-data']) !!}
<div class="form-group @if($errors->has('image_url')) has-error @endif">
    {!! Form::label('Image Url', null, ['style' => 'display: block;']) !!}
    {!! Form::file('image_url[]', ['multiple' => 'multiple']) !!}
    @if ($errors->has('image_url'))
        <span class="help-block">{!! $errors->first('image_url') !!}</span>
    @endif
</div>
{!! Form::submit('Create', ['class' => 'btn btn-sm btn-primary']) !!}
{!! Form::close() !!}
```

- run `php artisan storage:link`

### Contact Page

- `views/website/contact.blade.php`, copy bootstrap `contact.html` and copy header and content, paste in `contact.blade`, modify it.

```php
@include('layouts.flash')

{!! Form::open(['route' => 'contact.submit']) !!}
<div class="control-group">
<div class="form-group floating-label-form-group controls">
    <label>Name</label>
    <input type="text" name="name" class="form-control" placeholder="Name" id="name" required data-validation-required-message="Please enter your name.">
    <p class="help-block text-danger"></p>
</div>
</div>
<div class="control-group">
<div class="form-group floating-label-form-group controls">
    <label>Email Address</label>
    <input type="email" name="email" class="form-control" placeholder="Email Address" id="email" required data-validation-required-message="Please enter your email address.">
    <p class="help-block text-danger"></p>
</div>
</div>
<div class="control-group">
<div class="form-group col-xs-12 floating-label-form-group controls">
    <label>Phone Number</label>
    <input type="tel" name="tel" class="form-control" placeholder="Phone Number" id="phone" required data-validation-required-message="Please enter your phone number.">
    <p class="help-block text-danger"></p>
</div>
</div>
<div class="control-group">
<div class="form-group floating-label-form-group controls">
    <label>Message</label>
    <textarea name="message" rows="5" class="form-control" placeholder="Message" id="message" required data-validation-required-message="Please enter a message."></textarea>
    <p class="help-block text-danger"></p>
</div>
</div>
<br>
<div id="success"></div>
<button type="submit" class="btn btn-primary" id="sendMessageButton">Send</button>
{!! Form::close() !!}
```

- Run: `php artisan make:mail VisitorContact`, edit `VisitorContact.php`

```php
public $data;
public function __construct($data)
{
    $this->data = $data;
}
public function build()
{
    return $this->view('admin.email.contact');
}
```

- `WebsiteController`

```php
public function showContactForm() {
    return view('website.contact');
}

public function submitContactForm(Request $request) {
    $this->validate($request,
        [
            'name' => 'required',
            'email' => 'required',
            'tel' => 'required',
            'message' => 'required',
        ],
        [
            'name.required' => 'Name is required',
            'email.required' => 'Email is required',
            'tel.required' => 'Tel is required',
            'message.required' => 'Message is required'
        ],
    );
    $data = [
        'name' => $request->name,
        'email' => $request->email,
        'tel' => $request->tel,
        'message' => $request->message,
    ];
    Mail::to('media@qizhong.land')->send(new VisitorContact($data));

    Session::flash('message', 'Message sent successfully, thank you!');
    return redirect()-> route('contact.show');
}
```

- `views/admin/email/contact.blade.php`

```php
<body>
    <p>Name: {{ $data['name'] }}</p>
    <p>Email: {{ $data['email'] }}</p>
    <p>Tel: {{ $data['tel'] }}</p>
    <p>Message: {{ $data['message'] }}</p>
</body>
```

- Run: `php artisan config:cache`

- Use <http://mailtrap.io/> to test mail: copy Laravel prameters to `.env`, and send a message.


